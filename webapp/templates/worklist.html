{% extends "base.html" %}
{% block container_extra_class %} worklist-mode{% endblock %}

{% block content %}
  <h1>Staging Worklist</h1>

  <input
    id="worklist-search"
    type="search"
    placeholder="Search worklistâ€¦"
    class="search-input"
    style="margin-bottom:1rem;"
  >

  <div id="bulk-controls" style="margin-bottom:1.5rem;">
    <select id="bulk-field">
      <option value="" disabled selected>Select Field</option>
      <option value="collection_site">Collection Site</option>
      <option value="laboratory">Laboratory</option>
      <option value="test_reason">Test Reason</option>
      <option value="test_type">Test Type</option>
      <option value="test_result">Test Result</option>
      <option value="regulation">Regulation</option>
      <option value="regulation_body">Regulation Body</option>
      <option value="panel">Panel</option>
    </select>

    <!-- Autocomplete for Collection Site -->
    <input
      list="bulk-site-list"
      type="text"
      id="bulk-site-input"
      placeholder="Select Site"
      style="display:none; margin:0 0.5rem;"
    >
    <datalist id="bulk-site-list">
      {% for site in sites %}
        <option value="{{ site }}"></option>
      {% endfor %}
    </datalist>

    <!-- free-text fallback -->
    <input
      type="text"
      id="bulk-value-text"
      placeholder="New value"
      style="display:none; margin:0 0.5rem;"
    >

    <!-- dropdown for picklists -->
    <select
      id="bulk-value-select"
      style="display:none; margin:0 0.5rem;"
    ></select>

    <!-- hidden carry-through for site ID -->
    <input type="hidden" id="bulk-site-id" name="collection_site_id">

    <button id="bulk-apply" class="btn btn-secondary">Apply</button>
    <button id="bulk-send"  class="btn btn-primary">Send to CRM</button>
  </div>

  {% if items %}
    <div class="table-container">
      <table id="worklist-table" class="worklist-table">
        <thead>
          <tr>
            <th style="width:2rem; text-align:center; padding:0.25rem;">
              <input type="checkbox" id="select-all">
            </th>
            <th>CCFID</th>
            <th>Company</th>
            <th>First</th>
            <th>Last</th>
            <th>Test&nbsp;Type</th>
            <th>Needs&nbsp;Attention</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr
            data-ccfid             ="{{ it.ccfid }}"
            data-primary-id        ="{{ it.primary_id or '' }}"
            data-company-name      ="{{ it.company_name or '' }}"
            data-company-code      ="{{ it.company_code or '' }}"
            data-first-name        ="{{ it.first_name or '' }}"
            data-last-name         ="{{ it.last_name or '' }}"
            data-collection-date   ="{{ it.collection_date or '' }}"
            data-mro-received      ="{{ it.mro_received or '' }}"
            data-collection-site   ="{{ it.collection_site or '' }}"
            data-collection-site-id="{{ it.collection_site_id or '' }}"
            data-laboratory        ="{{ it.laboratory or '' }}"
            data-panel             ="{{ it.panel or '' }}"
            data-location          ="{{ it.location or '' }}"
            data-test-reason       ="{{ it.test_reason or '' }}"
            data-test-type         ="{{ it.test_type or '' }}"
            data-test-result       ="{{ it.test_result or '' }}"
            data-regulation        ="{{ it.regulation or '' }}"
            data-regulation-body   ="{{ it.regulation_body or '' }}"
            data-bat-value         ="{{ it.bat_value or '' }}"
            data-positive-for      ="{{ it.positive_for or '' }}"
          >
            <td style="text-align:center; padding:0.25rem;">
              <input type="checkbox" class="row-checkbox">
            </td>
            <td>{{ it.ccfid }}</td>
            <td>{{ it.company_name }}</td>
            <td>{{ it.first_name }}</td>
            <td>{{ it.last_name }}</td>
            <td>{{ it.test_type }}</td>
            <td class="needs-attention"></td>
            <td>
              <a href="{{ url_for('web.worklist_detail', ccfid=it.ccfid) }}">
                Resolve
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No staging items. Run the pipeline to populate.</p>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // expose back-end data for bulk controls
    window.siteMap = {{ site_map|tojson }};
    window.bulkFieldOptions = {
      collection_site:      [],
      collection_site_id:   [],
      location:             [],
      laboratory:           {{ laboratory_opts|tojson }},
      test_reason:          {{ test_reason_opts|tojson }},
      test_type:            {{ test_type_opts|tojson }},
      test_result:          {{ test_result_opts|tojson }},
      regulation:           {{ regulation_opts|tojson }},
      regulation_body:      {{ regulation_body_opts|tojson }},
      bat_value:            [],
      panel:                {{ panel_opts|tojson }}
    };
  </script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
