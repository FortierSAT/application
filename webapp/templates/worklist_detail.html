{% extends "base.html" %}

{% block content %}
  <h1>Review Record {{ item.ccfid }}</h1>
  <form method="post" class="detail-form">
    <div class="grid">
      <!-- Row 1: IDs & Company -->
      <div class="form-group">
        <label for="ccfid">CCFID</label>
        <input id="ccfid" name="ccfid" type="text" value="{{ item.ccfid }}" readonly>
      </div>
      <div class="form-group">
        <label for="primary_id">Primary ID</label>
        <input id="primary_id" name="primary_id" type="text" value="{{ item.primary_id }}" readonly>
      </div>
      <div class="form-group{% if not item.company_name %} missing{% endif %}">
        <label for="company_name">Company Name</label>
        <input id="company_name" name="company_name" type="text"
               value="{{ item.company_name or '' }}">
      </div>
      <div class="form-group{% if not item.company_code %} missing{% endif %}">
        <label for="company_code">Company Code</label>
        <input id="company_code" name="company_code" type="text"
               value="{{ item.company_code or '' }}">
      </div>

      <!-- Row 2: Personal & Location -->
      <div class="form-group{% if not item.first_name %} missing{% endif %}">
        <label for="first_name">First Name</label>
        <input id="first_name" name="first_name" type="text"
               value="{{ item.first_name or '' }}">
      </div>
      <div class="form-group{% if not item.last_name %} missing{% endif %}">
        <label for="last_name">Last Name</label>
        <input id="last_name" name="last_name" type="text"
               value="{{ item.last_name or '' }}">
      </div>
      <div class="form-group{% if not item.location %} missing{% endif %} hidden"
           id="location_group">
        <label for="location">Location</label>
        <input id="location" name="location" type="text"
               value="{{ item.location or '' }}">
      </div>

      <!-- Row 3: Dates -->
      <div class="form-group{% if not item.collection_date %} missing{% endif %}">
        <label for="collection_date">Collection Date</label>
        <input id="collection_date" name="collection_date" type="date"
               value="{{ item.collection_date }}">
      </div>
      <div class="form-group{% if not item.mro_received %} missing{% endif %}">
        <label for="mro_received">Result Date</label>
        <input id="mro_received" name="mro_received" type="date"
               value="{{ item.mro_received }}">
      </div>

      <!-- Row 4: Site & Lab -->
      <div class="form-group{% if not item.collection_site %} missing{% endif %}">
        <label for="collection_site_input">Collection Site</label>
        <input list="site-list" id="collection_site_input"
               name="collection_site" type="text"
               value="{{ item.collection_site or '' }}">
        <datalist id="site-list">
          {% for s in sites %}
            <option value="{{ s }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div class="form-group hidden">
        <label for="collection_site_id_input">Site ID</label>
        <input id="collection_site_id_input" name="collection_site_id"
               type="text" readonly
               value="{{ item.collection_site_id or '' }}">
      </div>
      <div class="form-group{% if not item.laboratory %} missing{% endif %}"
           id="laboratory_group">
        <label for="laboratory">Laboratory</label>
        <select id="laboratory" name="laboratory">
          <option value="">— select —</option>
          {% for opt in laboratory_opts %}
            <option value="{{ opt }}"
              {% if item.laboratory==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group{% if not item.panel %} missing{% endif %}"
           id="panel_group">
        <label for="panel">Panel</label>
        <select id="panel" name="panel">
          <option value="">— select —</option>
          {% for opt in panel_opts %}
            <option value="{{ opt }}"
              {% if item.panel==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Row 5: Reason, Type, Result -->
      <div class="form-group{% if not item.test_reason %} missing{% endif %}">
        <label for="test_reason">Test Reason</label>
        <select id="test_reason" name="test_reason">
          <option value="">— select —</option>
          {% for opt in test_reason_opts %}
            <option value="{{ opt }}"
              {% if item.test_reason==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group{% if not item.test_type %} missing{% endif %}"
           id="test_type_group">
        <label for="test_type">Test Type</label>
        <select id="test_type" name="test_type">
          <option value="">— select —</option>
          {% for opt in test_type_opts %}
            <option value="{{ opt }}"
              {% if item.test_type==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group{% if not item.test_result %} missing{% endif %}"
           id="test_result_group">
        <label for="test_result">Test Result</label>
        <select id="test_result" name="test_result">
          <option value="">— select —</option>
          {% for opt in test_result_opts %}
            <option value="{{ opt }}"
              {% if item.test_result==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Row 6: Regulation & Body & BAT -->
      <div class="form-group{% if not item.regulation %} missing{% endif %}"
           id="regulation_group">
        <label for="regulation">Regulation</label>
        <select id="regulation" name="regulation">
          <option value="">— select —</option>
          {% for opt in regulation_opts %}
            <option value="{{ opt }}"
              {% if item.regulation==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group{% if not item.regulation_body %} missing{% endif %} hidden"
           id="regulation_body_group">
        <label for="regulation_body">Regulation Body</label>
        <select id="regulation_body" name="regulation_body">
          <option value="">— select —</option>
          {% for opt in regulation_body_opts %}
            <option value="{{ opt }}"
              {% if item.regulation_body==opt %}selected{% endif %}>
              {{ opt }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group{% if not item.bat_value %} missing{% endif %} hidden"
           id="bat_value_group">
        <label for="bat_value">BAT Value</label>
        <input id="bat_value" name="bat_value" type="text"
               value="{{ item.bat_value or '' }}">
      </div>

      <!-- Row 7: Positive For -->
      <!-- Row 7: Positive For as clickable tags -->
      <div class="form-group{% if not item.positive_for %} missing{% endif %}"
           id="positive_for_group">
        <label for="positive_for_input">Positive For</label>

        <!-- This shows the selections -->
        <input id="positive_for_input" type="text" readonly
               class="tag-input" placeholder="Click to add..." />

        <!-- Hidden field that actually gets submitted -->
        <input id="positive_for" name="positive_for" type="hidden"
               value="{{ item.positive_for or '' }}"/>

        <!-- The list of all possible options as clickable tags -->
        <div id="positive_for_picker" class="tag-picker">
          {% for opt in positive_for_opts %}
            <span class="tag-option{% if item.positive_for and opt in item.positive_for.split(';') %} selected{% endif %}"
                  data-value="{{ opt }}">
              {{ opt }}
            </span>
          {% endfor %}
        </div>
      </div>


    </div>

    <div class="form-actions">
      <input type="submit" class="btn btn-primary" value="Save & Send">
      <a href="{{ url_for('web.worklist') }}" class="btn btn-link">← Back to Worklist</a>
    </div>
  </form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Collection-site sync + Regulation/Lab/BAT UI rules
    document.addEventListener("DOMContentLoaded", () => {
      const show = el => el.classList.remove("hidden");
      const hide = el => el.classList.add("hidden");

      // Site autocomplete
      const siteMap   = {{ site_map|tojson }};
      const siteIn    = document.getElementById("collection_site_input");
      const siteIdIn  = document.getElementById("collection_site_id_input");
      siteIn?.addEventListener("input", () => {
        siteIdIn.value = siteMap[siteIn.value] || "";
      });

      // Regulation → Body
      const reg      = document.getElementById("regulation");
      const regGrp   = document.getElementById("regulation_body_group");
      const regSel   = document.getElementById("regulation_body");
      const toggleR  = () => reg.value === "DOT" ? show(regGrp) : hide(regGrp);
      reg.addEventListener("change", toggleR);
      toggleR();

      // Test Type → Lab & BAT
      const typeEl   = document.getElementById("test_type");
      const labGrp   = document.getElementById("laboratory_group");
      const batGrp   = document.getElementById("bat_value_group");
      const toggleT  = () => {
        if (/poct|alcohol/i.test(typeEl.value)) hide(labGrp);
        else show(labGrp);
        if (/Alcohol Breath Test/i.test(typeEl.value)) show(batGrp);
        else hide(batGrp);
      };
      typeEl.addEventListener("change", toggleT);
      toggleT();

      // Company Code → Location
      const codeEl   = document.getElementById("company_code");
      const locGrp   = document.getElementById("location_group");
      const toggleC  = () => codeEl.value === "A1310" ? show(locGrp) : hide(locGrp);
      codeEl.addEventListener("input", toggleC);
      toggleC();

      // Test Result → Positive For
      const resEl    = document.getElementById("test_result");
      const posGrp   = document.getElementById("positive_for_group");
      const toggleP  = () => /^Positive/.test(resEl.value) ? show(posGrp) : hide(posGrp);
      resEl.addEventListener("change", toggleP);
      toggleP();

      // —— NEW: Positive For tag picker ——
      const picker    = document.getElementById("positive_for_picker");
      const hiddenIn  = document.getElementById("positive_for");
      const displayIn = document.getElementById("positive_for_input");

      // Start with whatever’s already in the hidden field
      let selected = hiddenIn.value
        ? hiddenIn.value.split(";").filter(v => v)
        : [];

      function refreshTags() {
        // Update display box
        displayIn.value = selected.join("; ");
        // Update each tag’s .selected class
        picker.querySelectorAll(".tag-option").forEach(el => {
          if (selected.includes(el.dataset.value)) el.classList.add("selected");
          else el.classList.remove("selected");
        });
        // Keep hidden input in sync
        hiddenIn.value = selected.join(";");
      }

      picker.querySelectorAll(".tag-option").forEach(el => {
        el.addEventListener("click", () => {
          const v = el.dataset.value;
          if (selected.includes(v)) {
            selected = selected.filter(x => x !== v);
          } else {
            selected.push(v);
          }
          refreshTags();
        });
      });

      // Initialize on load
      refreshTags();

    });
  </script>
{% endblock %}
